<!DOCTYPE html>
<html>
	<head>
		<title>Kubernetes-3d-visualizer</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link href="css/style.css" rel="stylesheet" type="text/css">
	</head>
	<body>
	    <script src="js/jsonpath-0.8.0.js"></script>
		<script src="js/three.js"></script>
		<script src="js/TrackballControls.js"></script>
		<script src="js/CSS3DRenderer.js"></script>
		<script src="js/nodes.js"></script>
		<script src="js/pods.js"></script>

		<script src="js/replicasets.js"></script>
		<script src="js/deployments.js"></script>
		<script src="js/initreload.js"></script>
		<script src="js/ingresses.js"></script>
		<script src="js/jquery-2.2.4.min.js"></script>

		<div id="info"><a href="" target="_blank" rel="noopener"></a> Kubernetes-3d-visualizer  <a href="https://github.com/reneschoonrok" target="_blank" rel="noopener">https://github.com/reneschoonrok</a>. <input type="checkbox" id="showingress" value="true" class="button button4" checked>Show Ingress. <input type="checkbox" id="httpsingress" value="true" class="button button4" checked>https alb<br></div>


		<div id="container"></div>
		<div id="menu">
			<button id="delete" class="button1">Delete</button>
			<button id="openspec"  class="button1">Open spec</button>
			<button id="addreplica"  class="button1">Replica +</button>
			<button id="delreplica"  class="button1">Replica -</button>
			<button id="refresh"  class="button1">Refresh</button>
		</div>
		<div class="info1-btn-group" id="info1menu">
			<textarea id="areatext1" rows="15" cols="70" class="button6" style="overflow:hidden;resize:none"></textarea>
		</div>
		<div class="info-btn-group" id="infomenu">
			<textarea id="areatext" rows="15" cols="110" class="button6" style="resize:none" ></textarea>
		</div>

		<div class="btn-group" id="mymenu">
			<button id="detail0" class="button button3"></button>
			<button id="detail12" class="button button3"></button>
			<button id="detail10" class="button button4"></button>
			<button id="detail11" class="button button2"></button>
			<button id="detail13" class="button button4"></button>
			<button id="detail14" class="button button2"></button>
				</div>

		<script>
			
			var resourcetypes = [
				"Nodes", "", "rgba(36, 61, 114, 0.4)", 1, 1, " ",
				"Namespaces", "", "rgba(0,127,127,0.4)", 1, 2, "",
				"Pods", "", "rgba(147, 232, 44,0.4)", 1, 3, " ",
				" ", "", "rgba(147, 232, 44,0.4)", 1, 4, " ",
				"Deployments", "", "rgba(200, 7, 200,0.4)", 1, 5, " ",
				" ", "", "rgba(200, 7, 200,0.4)", 1, 6, " ",
				"Replicasets", "", "rgba(56, 124, 52,0.4)", 1, 7, " ",
				" ", "", "rgba(56, 124, 52,0.4)", 1, 8, " ",
				"Ingress", "", "rgba(237, 149, 61,0.4)", 1, 9, " "
			];
			
			var namespaces = [
				"kube-system", "namespace", "rgba(0,127,127,0.2)", 5, 2, " ",
				"default", "namespace", "rgba(0,127,127,0.2)", 8, 2, " ",
				"dev", "namespace", "rgba(0,127,127,0.2)", 11, 2, " ",
				"tst", "namespace", "rgba(0,127,127,0.2)", 14, 2, " "
			];

			var nodeinfo = [];
			var podinfo = [];
			var replicaset = [];
			var deployment = [];
			var ingressinfo = [];
			var ingressurls = [];
			var camera, scene, renderer;
			var controls;
			var mesh;
			var bcolorchanger = 0;
			var rotateswitch = 1;

			var objects = [];
			var targets = { podinfo: [],  nodeinfo: [], resourcetypes: [],  namespaces: [], replicaset: [], deployment: [] };
			var longerlivables = { ingressinfo: []};
			var image = document.createElement( 'img' );
			var mynamespace = 'kube-system';
			var info = [];
			var clock = new THREE.Clock();

			var image = document.createElement('img');
						  image.src = './img/kubernetesword.png';
	     	var objectlogo = new THREE.CSS3DSprite(image.cloneNode());
            var texture1 = new THREE.TextureLoader().load( './img/containerready.png' );//glscene

        	var materialready = new THREE.MeshBasicMaterial( { map: texture1, opacity: 1} );//glscene
        	const materialnotready = new THREE.MeshBasicMaterial({color: 0xFF0000,wireframe: true,});

 			var boxGeom1 = new THREE.CubeGeometry(55,20, 20);//glscene

	var runnerTexture = new THREE.ImageUtils.loadTexture( './img/arrowgreen.png' );
	ingresstexture = new TextureAnimator( runnerTexture, 4, 1, 4, 275 ); // texture, #horiz, #vert, #total, duration.
	var runnerMaterial = new THREE.MeshBasicMaterial( { map: runnerTexture, side:THREE.DoubleSide } );
	var runnerGeometry = new THREE.PlaneGeometry(100, 30, 1, 1);
	var runner = new THREE.Mesh(runnerGeometry, runnerMaterial);
	runner.position.set(-100,25,0);

	var runner2Texture = new THREE.ImageUtils.loadTexture( './img/server6.png' );
	nodetexture = new TextureAnimator( runner2Texture, 6, 1, 6, 250 ); // texture, #horiz, #vert, #total, duration.
	var runner2Material = new THREE.MeshBasicMaterial( { map: runner2Texture, side:THREE.DoubleSide } );
	var runner2Geometry = new THREE.PlaneGeometry(100,42, 1, 1);
	var runner2 = new THREE.Mesh(runner2Geometry, runnerMaterial);
	runner2.position.set(-100,25,0);



 	init();
	animate();



  function createCssObject(w, h, position, rotation, url) {
    var html = [
      '<div style="width:' + w + 'px; height:' + h + 'px;">',
      '<iframe src="' + url + '" width="' + w + '" height="' + h + '">',
      '</iframe>',
      '</div>'
    ].join('\n');
    var div = document.createElement('div');
    $(div).html(html);
    var cssObject = new THREE.CSS3DObject(div);
    cssObject.castShadow = true;
    cssObject.position.x = position.x;
    cssObject.position.y = position.y;
    cssObject.position.z = position.z;
    cssObject.rotation.x = rotation.x;
    cssObject.rotation.y = rotation.y;
    cssObject.rotation.z = rotation.z;
    return cssObject;
  }


function TextureAnimator(texture, tilesHoriz, tilesVert, numTiles, tileDispDuration)
{
	this.tilesHorizontal = tilesHoriz;
	this.tilesVertical = tilesVert;
	this.numberOfTiles = numTiles;
	texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
	texture.repeat.set( 1 / this.tilesHorizontal, 1 / this.tilesVertical );

	// how long should each image be displayed?
	this.tileDisplayDuration = tileDispDuration;

	// how long has the current image been displayed?
	this.currentDisplayTime = 0;

	// which image is currently being displayed?
	this.currentTile = 0;

	this.update = function( milliSec )
	{
		this.currentDisplayTime += milliSec;
		while (this.currentDisplayTime > this.tileDisplayDuration)
		{
			this.currentDisplayTime -= this.tileDisplayDuration;
			this.currentTile++;
			if (this.currentTile == this.numberOfTiles)
				this.currentTile = 0;
			var currentColumn = this.currentTile % this.tilesHorizontal;
			texture.offset.x = currentColumn / this.tilesHorizontal;
			var currentRow = Math.floor( this.currentTile / this.tilesHorizontal );
			texture.offset.y = currentRow / this.tilesVertical;
		}
	};
}


  function create3dPage(w, h, position, rotation, url) {
   var cssObject = createCssObject(
        w, h,
        position,
        rotation,
        url);
    scene.add(cssObject);
    return cssObject;
  }

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
				render();
			}

			function animate() {

				requestAnimationFrame( animate );

				render();
				controls.update();

			}
			
			function render() {

			var delta = clock.getDelta();
			ingresstexture.update(1000 * delta);
			nodetexture.update(1000 * delta);

			if ((cube.rotation.x < -6.25)&&(rotateswitch == 1))
			{
			    rotateswitch = 0;
			    cube.rotation.y =0;
			    //cube1.rotation.y =0;

			 };
			 if ((cube.rotation.y < -6.25)&&(rotateswitch == 0))
			 {
			    rotateswitch = 1;
			    cube.rotation.x =0;
			    //cube1.rotation.x =0;


			 };

				if (rotateswitch == 1) {
				  cube.rotation.x -=0.02;
			      //cube1.rotation.x -=0.02;

			    }
			    else {
				  cube.rotation.y -=0.02;
			      //cube1.rotation.y +=0.02;

			    };

			      scene.add(objectlogo);

			     //scene.add(mycssObject);


			      objects.push(objectlogo);
			      //objects.push(mycssObject);
			      rendererGl.render(sceneGl, camera);
				renderer.render( scene, camera );


			}
			
			var intervalID = window.setInterval(myRefresh, 1500);

			function myRefresh() {
		
				reload();
				loadinfo();
				//loadreplicasets();
				loaddeployments();
				loadingresses();
				loadnodes();
				//create3dPage( 400, 400, new THREE.Vector3(550, 500, 0),  new THREE.Vector3(0, 0, 0), 'https://threejs.org/examples/#webgl_materials_envmaps_exr');

				podinfo.splice(0, podinfo.length)
				//replicaset.splice(0, replicaset.length)
				deployment.splice(0, deployment.length)
				nodeinfo.splice(0, nodeinfo.length)
				ingressinfo.splice(0, ingressinfo.length)
			}

			var intervalID = window.setInterval(myRefreshIngress,20000);
			function myRefreshIngress() {
    		   if (showingress.checked){
			      for (var i = scene.children.length-1; i > -1; i -= 1){
       		   	    if (scene.children[i].castShadow == true){
          		    scene.remove(scene.children[i]);
        		   };
        		   }

			      var xpos = 0;
			      for ( var i = 0; i < ingressurls.length; i += 1 ) {
			      if (httpsingress.checked){
			         create3dPage( 400, 600, new THREE.Vector3(-627+xpos, -1020, 0),  new THREE.Vector3(0, 0, 0), 'https://'+ingressurls[i]);
				  }
				  else {
				     create3dPage( 400, 600, new THREE.Vector3(-627+xpos, -1020, 0),  new THREE.Vector3(0, 0, 0), 'http://'+ingressurls[i]);
				  };
				  xpos +=415;
			      }
			   }
			}
		</script>
	</body>
</html>
